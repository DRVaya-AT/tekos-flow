{"version":3,"sources":["../src/pushprocessor.js"],"names":["RULEKINDS_IN_ORDER","DEFAULT_OVERRIDE_RULES","rule_id","default","enabled","conditions","kind","key","pattern","actions","set_tweak","value","PushProcessor","client","cachedGlobToRegex","matchingRuleFromKindSet","ev","kindset","device","ruleKindIndex","length","ruleset","ruleIndex","rule","rawrule","templateRuleToRaw","ruleMatchesEvent","tprule","push","eventFulfillsCondition","cond","condition_functions","eventFulfillsEventMatchCondition","eventFulfillsDeviceCondition","eventFulfillsDisplayNameCondition","eventFulfillsRoomMemberCountCondition","eventFulfillsSenderNotifPermCondition","notifLevelKey","room","getRoom","getRoomId","currentState","mayTriggerNotifOfType","getSender","is","members","memberCount","getJoinedMemberCount","m","match","ineq","rhs","parseInt","isNaN","content","getContent","isEncrypted","getClearContent","body","getMember","credentials","userId","displayName","name","pat","RegExp","search","val","valueForDottedKey","regex","createCachedRegex","prefix","glob","suffix","parts","split","firstPart","shift","getType","event","thispart","matchingRuleForEventWithRulesets","rulesets","allDevNames","i","devname","devrules","matchingRule","global","pushActionsForEventAndRulesets","actionObj","actionListToActionsObject","tweaks","highlight","undefined","applyRuleDefaults","clientRuleset","JSON","parse","globalOverrides","override","existingRule","find","r","ruleId","console","warn","ret","actionsForEvent","rules","pushRules","getPushRuleById","scope","actionlist","actionobj","action","notify","module","exports"],"mappings":"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","file":"pushprocessor.js","sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2017 New Vector Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport {escapeRegExp, globToRegexp} from \"./utils\";\n\n/**\n * @module pushprocessor\n */\n\nconst RULEKINDS_IN_ORDER = ['override', 'content', 'room', 'sender', 'underride'];\n\n// The default override rules to apply when calculating actions for an event. These\n// defaults apply under no other circumstances to avoid confusing the client with server\n// state. We do this for two reasons:\n//   1. Synapse is unlikely to send us the push rule in an incremental sync - see\n//      https://github.com/matrix-org/synapse/pull/4867#issuecomment-481446072 for\n//      more details.\n//   2. We often want to start using push rules ahead of the server supporting them,\n//      and so we can put them here.\nconst DEFAULT_OVERRIDE_RULES = [\n    {\n        // For homeservers which don't support MSC1930 yet\n        rule_id: \".m.rule.tombstone\",\n        default: true,\n        enabled: true,\n        conditions: [\n            {\n                kind: \"event_match\",\n                key: \"type\",\n                pattern: \"m.room.tombstone\",\n            },\n        ],\n        actions: [\n            \"notify\",\n            {\n                set_tweak: \"highlight\",\n                value: true,\n            },\n        ],\n    },\n];\n\n/**\n * Construct a Push Processor.\n * @constructor\n * @param {Object} client The Matrix client object to use\n */\nfunction PushProcessor(client) {\n    const cachedGlobToRegex = {\n        // $glob: RegExp,\n    };\n\n    const matchingRuleFromKindSet = (ev, kindset, device) => {\n        for (let ruleKindIndex = 0;\n                ruleKindIndex < RULEKINDS_IN_ORDER.length;\n                ++ruleKindIndex) {\n            const kind = RULEKINDS_IN_ORDER[ruleKindIndex];\n            const ruleset = kindset[kind];\n\n            for (let ruleIndex = 0; ruleIndex < ruleset.length; ++ruleIndex) {\n                const rule = ruleset[ruleIndex];\n                if (!rule.enabled) {\n                    continue;\n                }\n\n                const rawrule = templateRuleToRaw(kind, rule, device);\n                if (!rawrule) {\n                    continue;\n                }\n\n                if (this.ruleMatchesEvent(rawrule, ev)) {\n                    rule.kind = kind;\n                    return rule;\n                }\n            }\n        }\n        return null;\n    };\n\n    const templateRuleToRaw = function(kind, tprule, device) {\n        const rawrule = {\n            'rule_id': tprule.rule_id,\n            'actions': tprule.actions,\n            'conditions': [],\n        };\n        switch (kind) {\n            case 'underride':\n            case 'override':\n                rawrule.conditions = tprule.conditions;\n                break;\n            case 'room':\n                if (!tprule.rule_id) {\n                    return null;\n                }\n                rawrule.conditions.push({\n                    'kind': 'event_match',\n                    'key': 'room_id',\n                    'value': tprule.rule_id,\n                });\n                break;\n            case 'sender':\n                if (!tprule.rule_id) {\n                    return null;\n                }\n                rawrule.conditions.push({\n                    'kind': 'event_match',\n                    'key': 'user_id',\n                    'value': tprule.rule_id,\n                });\n                break;\n            case 'content':\n                if (!tprule.pattern) {\n                    return null;\n                }\n                rawrule.conditions.push({\n                    'kind': 'event_match',\n                    'key': 'content.body',\n                    'pattern': tprule.pattern,\n                });\n                break;\n        }\n        if (device) {\n            rawrule.conditions.push({\n                'kind': 'device',\n                'profile_tag': device,\n            });\n        }\n        return rawrule;\n    };\n\n    const eventFulfillsCondition = function(cond, ev) {\n        const condition_functions = {\n            \"event_match\": eventFulfillsEventMatchCondition,\n            \"device\": eventFulfillsDeviceCondition,\n            \"contains_display_name\": eventFulfillsDisplayNameCondition,\n            \"room_member_count\": eventFulfillsRoomMemberCountCondition,\n            \"sender_notification_permission\": eventFulfillsSenderNotifPermCondition,\n        };\n        if (condition_functions[cond.kind]) {\n            return condition_functions[cond.kind](cond, ev);\n        }\n        // unknown conditions: we previously matched all unknown conditions,\n        // but given that rules can be added to the base rules on a server,\n        // it's probably better to not match unknown conditions.\n        return false;\n    };\n\n    const eventFulfillsSenderNotifPermCondition = function(cond, ev) {\n        const notifLevelKey = cond['key'];\n        if (!notifLevelKey) {\n            return false;\n        }\n\n        const room = client.getRoom(ev.getRoomId());\n        if (!room || !room.currentState) {\n            return false;\n        }\n\n        // Note that this should not be the current state of the room but the state at\n        // the point the event is in the DAG. Unfortunately the js-sdk does not store\n        // this.\n        return room.currentState.mayTriggerNotifOfType(notifLevelKey, ev.getSender());\n    };\n\n    const eventFulfillsRoomMemberCountCondition = function(cond, ev) {\n        if (!cond.is) {\n            return false;\n        }\n\n        const room = client.getRoom(ev.getRoomId());\n        if (!room || !room.currentState || !room.currentState.members) {\n            return false;\n        }\n\n        const memberCount = room.currentState.getJoinedMemberCount();\n\n        const m = cond.is.match(/^([=<>]*)([0-9]*)$/);\n        if (!m) {\n            return false;\n        }\n        const ineq = m[1];\n        const rhs = parseInt(m[2]);\n        if (isNaN(rhs)) {\n            return false;\n        }\n        switch (ineq) {\n            case '':\n            case '==':\n                return memberCount == rhs;\n            case '<':\n                return memberCount < rhs;\n            case '>':\n                return memberCount > rhs;\n            case '<=':\n                return memberCount <= rhs;\n            case '>=':\n                return memberCount >= rhs;\n            default:\n                return false;\n        }\n    };\n\n    const eventFulfillsDisplayNameCondition = function(cond, ev) {\n        let content = ev.getContent();\n        if (ev.isEncrypted() && ev.getClearContent()) {\n            content = ev.getClearContent();\n        }\n        if (!content || !content.body || typeof content.body != 'string') {\n            return false;\n        }\n\n        const room = client.getRoom(ev.getRoomId());\n        if (!room || !room.currentState || !room.currentState.members ||\n            !room.currentState.getMember(client.credentials.userId)) {\n            return false;\n        }\n\n        const displayName = room.currentState.getMember(client.credentials.userId).name;\n\n        // N.B. we can't use \\b as it chokes on unicode. however \\W seems to be okay\n        // as shorthand for [^0-9A-Za-z_].\n        const pat = new RegExp(\"(^|\\\\W)\" + escapeRegExp(displayName) + \"(\\\\W|$)\", 'i');\n        return content.body.search(pat) > -1;\n    };\n\n    const eventFulfillsDeviceCondition = function(cond, ev) {\n        return false; // XXX: Allow a profile tag to be set for the web client instance\n    };\n\n    const eventFulfillsEventMatchCondition = function(cond, ev) {\n        if (!cond.key) {\n            return false;\n        }\n\n        const val = valueForDottedKey(cond.key, ev);\n        if (!val || typeof val != 'string') {\n            return false;\n        }\n\n        if (cond.value) {\n            return cond.value === val;\n        }\n\n        let regex;\n\n        if (cond.key == 'content.body') {\n            regex = createCachedRegex('(^|\\\\W)', cond.pattern, '(\\\\W|$)');\n        } else {\n            regex = createCachedRegex('^', cond.pattern, '$');\n        }\n\n        return !!val.match(regex);\n    };\n\n    const createCachedRegex = function(prefix, glob, suffix) {\n        if (cachedGlobToRegex[glob]) {\n            return cachedGlobToRegex[glob];\n        }\n        cachedGlobToRegex[glob] = new RegExp(\n            prefix + globToRegexp(glob) + suffix,\n            'i', // Case insensitive\n        );\n        return cachedGlobToRegex[glob];\n    };\n\n    const valueForDottedKey = function(key, ev) {\n        const parts = key.split('.');\n        let val;\n\n        // special-case the first component to deal with encrypted messages\n        const firstPart = parts[0];\n        if (firstPart == 'content') {\n            val = ev.getContent();\n            parts.shift();\n        } else if (firstPart == 'type') {\n            val = ev.getType();\n            parts.shift();\n        } else {\n            // use the raw event for any other fields\n            val = ev.event;\n        }\n\n        while (parts.length > 0) {\n            const thispart = parts.shift();\n            if (!val[thispart]) {\n                return null;\n            }\n            val = val[thispart];\n        }\n        return val;\n    };\n\n    const matchingRuleForEventWithRulesets = function(ev, rulesets) {\n        if (!rulesets || !rulesets.device) {\n            return null;\n        }\n        if (ev.getSender() == client.credentials.userId) {\n            return null;\n        }\n\n        const allDevNames = Object.keys(rulesets.device);\n        for (let i = 0; i < allDevNames.length; ++i) {\n            const devname = allDevNames[i];\n            const devrules = rulesets.device[devname];\n\n            const matchingRule = matchingRuleFromKindSet(devrules, devname);\n            if (matchingRule) {\n                return matchingRule;\n            }\n        }\n        return matchingRuleFromKindSet(ev, rulesets.global);\n    };\n\n    const pushActionsForEventAndRulesets = function(ev, rulesets) {\n        const rule = matchingRuleForEventWithRulesets(ev, rulesets);\n        if (!rule) {\n            return {};\n        }\n\n        const actionObj = PushProcessor.actionListToActionsObject(rule.actions);\n\n        // Some actions are implicit in some situations: we add those here\n        if (actionObj.tweaks.highlight === undefined) {\n            // if it isn't specified, highlight if it's a content\n            // rule but otherwise not\n            actionObj.tweaks.highlight = (rule.kind == 'content');\n        }\n\n        return actionObj;\n    };\n\n    const applyRuleDefaults = function(clientRuleset) {\n        // Deep clone the object before we mutate it\n        const ruleset = JSON.parse(JSON.stringify(clientRuleset));\n\n        if (!clientRuleset['global']) {\n            clientRuleset['global'] = {};\n        }\n        if (!clientRuleset['global']['override']) {\n            clientRuleset['global']['override'] = [];\n        }\n\n        // Apply default overrides\n        const globalOverrides = clientRuleset['global']['override'];\n        for (const override of DEFAULT_OVERRIDE_RULES) {\n            const existingRule = globalOverrides\n                .find((r) => r.rule_id === override.rule_id);\n\n            if (!existingRule) {\n                const ruleId = override.rule_id;\n                console.warn(`Adding default global override for ${ruleId}`);\n                globalOverrides.push(override);\n            }\n        }\n\n        return ruleset;\n    };\n\n    this.ruleMatchesEvent = function(rule, ev) {\n        let ret = true;\n        for (let i = 0; i < rule.conditions.length; ++i) {\n            const cond = rule.conditions[i];\n            ret &= eventFulfillsCondition(cond, ev);\n        }\n        //console.log(\"Rule \"+rule.rule_id+(ret ? \" matches\" : \" doesn't match\"));\n        return ret;\n    };\n\n\n    /**\n     * Get the user's push actions for the given event\n     *\n     * @param {module:models/event.MatrixEvent} ev\n     *\n     * @return {PushAction}\n     */\n    this.actionsForEvent = function(ev) {\n        const rules = applyRuleDefaults(client.pushRules);\n        return pushActionsForEventAndRulesets(ev, rules);\n    };\n\n    /**\n     * Get one of the users push rules by its ID\n     *\n     * @param {string} ruleId The ID of the rule to search for\n     * @return {object} The push rule, or null if no such rule was found\n     */\n    this.getPushRuleById = function(ruleId) {\n        for (const scope of ['device', 'global']) {\n            if (client.pushRules[scope] === undefined) continue;\n\n            for (const kind of RULEKINDS_IN_ORDER) {\n                if (client.pushRules[scope][kind] === undefined) continue;\n\n                for (const rule of client.pushRules[scope][kind]) {\n                    if (rule.rule_id === ruleId) return rule;\n                }\n            }\n        }\n        return null;\n    };\n}\n\n/**\n * Convert a list of actions into a object with the actions as keys and their values\n * eg. [ 'notify', { set_tweak: 'sound', value: 'default' } ]\n *     becomes { notify: true, tweaks: { sound: 'default' } }\n * @param {array} actionlist The actions list\n *\n * @return {object} A object with key 'notify' (true or false) and an object of actions\n */\nPushProcessor.actionListToActionsObject = function(actionlist) {\n    const actionobj = { 'notify': false, 'tweaks': {} };\n    for (let i = 0; i < actionlist.length; ++i) {\n        const action = actionlist[i];\n        if (action === 'notify') {\n            actionobj.notify = true;\n        } else if (typeof action === 'object') {\n            if (action.value === undefined) {\n                action.value = true;\n            }\n            actionobj.tweaks[action.set_tweak] = action.value;\n        }\n    }\n    return actionobj;\n};\n\n/**\n * @typedef {Object} PushAction\n * @type {Object}\n * @property {boolean} notify Whether this event should notify the user or not.\n * @property {Object} tweaks How this event should be notified.\n * @property {boolean} tweaks.highlight Whether this event should be highlighted\n * on the UI.\n * @property {boolean} tweaks.sound Whether this notification should produce a\n * noise.\n */\n\n/** The PushProcessor class. */\nmodule.exports = PushProcessor;\n\n"]}